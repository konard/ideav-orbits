# Требования к планированию ресурсов проекта

## Общее описание

Данный документ описывает требования к системе планирования ресурсов для проектов в системе integram.io/orbits. Система автоматически планирует задачи и операции проектов, назначает исполнителей с учётом их квалификации, доступности и параметров задач.

---

## 1. Архитектура и компоненты системы

### 1.1 Основные файлы
- **project-scheduler.js** - основной скрипт планировщика с функциями расчёта длительности, планирования времени и назначения исполнителей
- **test-scheduler.js** - тесты для проверки корректности планирования
- **test-executor-assignment.js** - тесты для проверки назначения исполнителей
- **test-executors-from-template.js** - тесты для проверки чтения данных из шаблонов
- **demo.html** - демонстрационная страница с инструкциями
- **README.md** - основная документация проекта

### 1.2 Структура проекта
```
orbits/
├── project-scheduler.js          # Основной планировщик
├── test-scheduler.js             # Тесты планирования
├── test-executor-assignment.js   # Тесты исполнителей
├── test-executors-from-template.js # Тесты шаблонов
├── demo.html                     # Демо-страница
├── README.md                     # Документация
├── experiments/                  # Экспериментальные скрипты
│   ├── test-parameter-fallback.js
│   ├── test-parameter-merge.js
│   └── test-issue-15-parameter-merge.js
└── Результаты запросов по API.txt # Примеры ответов API
```

---

## 2. API и интеграция с системой

### 2.1 Глобальные переменные
Для работы скрипта необходимы следующие глобальные переменные на странице:
- `db` - имя текущей базы данных (например, "orbits")
- `xsrf` - токен XSRF для POST-запросов

### 2.2 API Endpoints

#### Получение данных проекта
```
GET https://{host}/{db}/report/2681?JSON_KV
```
Возвращает список задач и операций проекта и шаблона с полями:
- `ПроектID` - ID проекта
- `Проект` - название проекта
- `Старт` - дата старта проекта (формат: dd.mm.yyyy)
- `Задача проектаID` - ID задачи
- `Задача проекта` - название задачи
- `ОперацияID` - ID операции (если есть)
- `Операция` - название операции (если есть)
- `Норматив задачи` - длительность задачи в минутах
- `Норматив операции` - длительность операции в минутах
- `Кол-во` / `К-во` - количество для умножения норматива
- `Предыдущая Задача` - название предыдущей задачи (зависимость)
- `Предыдущая Операция` - название предыдущей операции (зависимость)
- `Шаблон Проекта (Проект)` - ID шаблонного проекта
- `Статус проекта` - статус проекта ("В работе" для активных)
- `Параметры задачи` - параметры задачи (формат описан ниже)
- `Параметры операции` - параметры операции (формат описан ниже)
- `Исполнителей` - количество требуемых исполнителей для операции

Исполнитель - это псевдоним таблицы Пользователь, эти имена эквивалентны.

#### Получение настроек рабочего времени
```
GET https://{host}/{db}/report/3283?JSON_KV
```
Возвращает конфигурацию рабочего дня:
- `day_start` - начало рабочего дня (час, например 9)
- `day_end` - конец рабочего дня (час, например 18)
- `lunch_start` - начало обеденного перерыва (час, например 13)

#### Получение справочника параметров
```
GET https://{host}/{db}/report/3248?JSON_KV
```
Возвращает список доступных параметров:
- `ПараметрID` - ID параметра
- `Параметр` - описание параметра

Примеры параметров:
- `115` - Пользователь → Роль
- `2673` - Квалификация → Уровень
- `728` - Пользователь → Квалификация
- `740` - Операция → Дата подтверждения
- `1015` - Задача проекта → Подтверждено заказчиком

#### Получение списка исполнителей
```
GET https://{host}/{db}/report/2777?JSON_KV
```
Возвращает список доступных исполнителей:
- `Исполнитель` - имя/email исполнителя
- `ПользовательID` - ID пользователя
- `Квалификация -> Уровень` - уровень квалификации
- `Занятое время` - предзаполненное занятое время (формат: yyyymmdd:h-h)
- `Роль` - ID роли пользователя
- `Контролер` - метка контролера ("X" если является контролером)
- `Наставник` - метка наставника ("X" если является наставником)

#### Сохранение данных
```
POST https://{host}/{db}/_m_set/{itemId}?JSON=1
Content-Type: application/x-www-form-urlencoded

{fieldCode}={value}&_xsrf={token}
```

---

## 3. Коды полей для сохранения данных

### 3.1 Коды полей (field codes)

| Поле | Код | Описание |
|------|-----|----------|
| Длительность задачи | `t3094` | Длительность в минутах |
| Длительность операции | `t704` | Длительность в минутах |
| Время начала задачи | `t798` | Формат: "dd.mm.yyyy HH:MM:SS" |
| Время начала операции | `t2665` | Формат: "dd.mm.yyyy HH:MM:SS" |
| Исполнитель задачи | `t690` | ID исполнителя или список через запятую |
| Исполнитель операции | `t2399` | ID исполнителя или список через запятую |

### 3.2 Происхождение кода `t2399`

**Контекст и обоснование:**
- В системе integram.io каждое поле имеет уникальный код, начинающийся с `t` (типа данных)
- Код `t2399` представляет поле "Исполнитель операции" в базе данных
- Этот код используется для сохранения назначенных исполнителей на операции через API
- Аналогичный код для задач - `t690` (исполнитель задачи)

**История внедрения:**
1. Issue #1 - создана система планирования времени для задач и операций
2. Issue #3 - добавлена функциональность назначения исполнителей
3. PR #4 - реализован полный алгоритм назначения исполнителей с сохранением в поля `t690` (задачи) и `t2399` (операции)
4. Issues #5, #7, #9, #11, #13, #15 - улучшения логики параметров и их объединения

**Техническое использование:**
```javascript
const CONFIG = {
    taskExecutorCode: 't690',        // Код поля исполнителя задачи
    operationExecutorCode: 't2399',  // Код поля исполнителя операции
};

// Сохранение исполнителей операции
await saveData(operationId, CONFIG.operationExecutorCode, executorIds.join(','));
```

---

## 4. Алгоритмы планирования

### 4.1 Расчёт длительности задач и операций

**Приоритет источников нормативов (в порядке убывания):**
1. **Существующий норматив в проекте** - если уже указана длительность > 0, она не перезаписывается
2. **Норматив из шаблона × количество** - берётся норматив из шаблонного проекта и умножается на количество
3. **Значение по умолчанию** - если норматив не найден в шаблоне (60 минут)

**Обработка количества:**
- Если `Кол-во` пустое, не указано или равно 0 → считается = 1
- Если `Кол-во` содержит нечисловое значение → считается = 1

**Процесс:**
1. Для каждой задачи/операции проекта "В работе" проверяется наличие существующей длительности
2. Если длительность отсутствует или равна 0, ищется соответствующая задача/операция в шаблонном проекте по названию
3. Норматив из шаблона умножается на количество из текущей задачи/операции
4. Рассчитанная длительность сохраняется в систему через POST-запрос

### 4.2 Планирование времени начала

**Учитываемые факторы:**
- **Рабочее время** - планирование только в пределах рабочего дня (по умолчанию 9:00-18:00)
- **Обеденный перерыв** - автоматически учитывается и пропускается (по умолчанию 13:00-14:00, 1 час)
- **Последовательность выполнения** - задачи в данных упорядочены по последовательности
- **Зависимости** - если указана "Предыдущая Операция" или "Предыдущая Задача", начало планируется не раньше завершения предыдущей
- **Короткие задачи** - задачи длительностью ≤ 4 часов не разбиваются на разные дни

**Алгоритм:**
1. Старт проекта берётся из поля "Старт" (формат: dd.mm.yyyy)
2. Для каждой задачи/операции:
   - Определяется начальное время (старт проекта или завершение предыдущей задачи)
   - Проверяется зависимость от предыдущей задачи/операции
   - Выбирается максимальное время из последовательности и зависимости
   - Добавляется длительность с учётом рабочего времени и обеда
3. Время начала сохраняется в систему

### 4.3 Назначение исполнителей

**Процесс назначения:**
1. **Парсинг параметров задачи/операции** в формате:
   - `ParamID:Value(-)` - точное значение (например, `115:849(-)`)
   - `ParamID:(MIN-MAX)` - диапазон значений (например, `2673:(1-2)`)
   - `ParamID:%(-)` - поле должно быть заполнено (например, `740:%(-)`)

2. **Объединение параметров задачи и операции:**
   - При совпадении кодов параметров, параметры операции имеют высший приоритет (Issue #15)
   - Параметры задачи используются как fallback, если параметры операции не заполнены (Issue #9, #11, #13)

3. **Валидация исполнителей:**
   - Проверка соответствия квалификации (параметр 2673)
   - Проверка роли (параметр 115)
   - Проверка других параметров из задачи/операции

4. **Проверка доступности:**
   - Проверка предзаполненного поля "Занятое время"
   - Проверка текущих назначений в рамках планирования
   - Проверка пересечений временных интервалов

5. **Множественные исполнители:**
   - Чтение поля "Исполнителей" из операции (из шаблона, Issue #5)
   - Назначение нужного количества исполнителей
   - Предупреждение, если не хватает подходящих исполнителей

6. **Сохранение назначений:**
   - Для задач: поле `t690`
   - Для операций: поле `t2399`
   - Формат: список ID через запятую (например, "1370,854")

---

## 5. Форматы данных

### 5.1 Даты и время
- **Дата** (например, Старт проекта): `dd.mm.yyyy` (пример: `20.11.2025`)
- **Дата и время** (например, время начала): `dd.mm.yyyy HH:MM:SS` (пример: `29.11.2025 17:39:00`)

### 5.2 Параметры задач и операций
Формат строки параметров: `ParamID:Value(Range)`

**Примеры:**
- `115:849(-)` - Роль = 849 (точное значение)
- `2673:(1-2)` - Уровень квалификации от 1 до 2 (диапазон)
- `2673:(4-)` - Уровень квалификации от 4 и выше (минимум)
- `740:%(-)` - Дата подтверждения должна быть заполнена (обязательное поле)
- `728:3235(-)` - Квалификация = 3235 (точное значение)

**Парсинг:**
- Разделитель параметров: запятая `,`
- Формат каждого параметра: `ID:Value(Range)`
- Если `Value = %`, то поле должно быть заполнено (не пустое)
- Если `Range = MIN-MAX`, то значение должно быть в диапазоне
- Если `Range = MIN-`, то значение должно быть ≥ MIN
- Если `Range = -MAX`, то значение должно быть ≤ MAX
- Если `Range = -`, то точное значение

### 5.3 Занятое время исполнителей
Формат: `yyyymmdd:h-h[,yyyymmdd:h-h,...]`

**Примеры:**
- `20251124:9-13` - 24 ноября 2025, с 9:00 до 13:00
- `20251121:9-12,20251122:8-11` - два периода занятости

---

## 6. Конфигурация системы

### 6.1 CONFIG объект
```javascript
const CONFIG = {
    // API endpoints
    projectReportId: 2681,           // ID отчёта с данными проекта
    workHoursReportId: 3283,         // ID отчёта с настройками рабочего времени
    parametersReportId: 3248,        // ID отчёта с параметрами
    executorsReportId: 2777,         // ID отчёта с исполнителями

    // Field codes for saving data
    taskDurationCode: 't3094',       // Код параметра длительности задачи
    operationDurationCode: 't704',   // Код параметра длительности операции
    taskStartCode: 't798',           // Код параметра времени начала задачи
    operationStartCode: 't2665',     // Код параметра времени начала операции
    taskExecutorCode: 't690',        // Код параметра исполнителя задачи
    operationExecutorCode: 't2399',  // Код параметра исполнителя операции

    // Default values
    defaultDuration: 60,             // Длительность по умолчанию (минуты)
    lunchDuration: 60,               // Длительность обеда (минуты)
};
```

### 6.2 Настраиваемые параметры
- **Рабочее время**: настраивается через отчёт 3283 (day_start, day_end, lunch_start)
- **ID отчётов**: настраиваются в CONFIG объекте
- **Коды полей**: настраиваются в CONFIG объекте
- **Длительность по умолчанию**: настраивается в CONFIG.defaultDuration
- **Длительность обеда**: настраивается в CONFIG.lunchDuration

---

## 7. Тестирование

### 7.1 Тесты планировщика (test-scheduler.js)
```
✓ Parse Quantity: 5/5 passed
✓ Parse Duration: 4/4 passed
✓ Date Parsing: 3/3 passed
✓ Template Lookup: 3/3 passed
✓ Duration Calculation: 2/2 passed
✓ Working Hours Calculation: 3/3 passed

Final Result: 6/6 test groups passed
```

**Проверяемые аспекты:**
- Парсинг количества из различных форматов
- Парсинг длительности
- Парсинг дат
- Поиск соответствий в шаблоне
- Расчёт длительности с учётом нормативов
- Расчёт рабочего времени с обедом

### 7.2 Тесты назначения исполнителей (test-executor-assignment.js)
```
✓ Parse Parameter String: 6/6 passed
✓ Parse Busy Time: 3/3 passed
✓ Validate Executor Parameters: 6/6 passed
✓ Executor Availability: 4/4 passed
✓ Multiple Executors Assignment: 1/1 passed

Final Result: 5/5 test groups passed
```

**Проверяемые аспекты:**
- Парсинг строки параметров
- Парсинг занятого времени
- Валидация исполнителей по параметрам
- Проверка доступности исполнителей
- Назначение множественных исполнителей

### 7.3 Тесты чтения из шаблона (test-executors-from-template.js)
Проверяет корректность чтения поля "Исполнителей" из шаблонного проекта (Issue #5).

### 7.4 Контрольный список перед деплоем

**Тест 1: Нормативы**
- ✓ Задача без норматива получает норматив из шаблона
- ✓ Операция без норматива получает норматив из шаблона
- ✓ Умножение на количество работает корректно
- ✓ Существующие нормативы не перезаписываются

**Тест 2: Время**
- ✓ Дата старта проекта парсится корректно
- ✓ Время не назначается на нерабочие часы
- ✓ Обеденный перерыв учитывается
- ✓ Зависимости между задачами соблюдаются

**Тест 3: Отображение**
- ✓ В таблице нет NaN или undefined
- ✓ Даты отображаются в читаемом формате
- ✓ Длительность рассчитывается корректно
- ✓ Статусы нормативов понятны

---

## 8. Использование

### 8.1 Базовое использование
1. Разместите скрипт на странице системы integram.io:
```html
<div class="content"></div>
<script src="project-scheduler.js"></script>
```

2. Убедитесь, что на странице доступны глобальные переменные `db` и `xsrf`

3. Скрипт автоматически:
   - Загрузит данные проекта, шаблона, исполнителей, параметры
   - Рассчитает длительность для задач и операций
   - Построит график с учётом рабочего времени и зависимостей
   - Назначит исполнителей с учётом квалификации и доступности
   - Сохранит все данные в систему
   - Отобразит результат в виде таблицы

### 8.2 Отображение результатов
Скрипт создаёт HTML-таблицу с колонками:
- № - порядковый номер
- Задача - название задачи
- Операция - название операции (если есть)
- Длительность (мин) - рассчитанная длительность
- Источник норматива - откуда взят норматив (Шаблон, Проект, По умолчанию)
- Количество - количество для умножения
- Время начала - запланированное время начала
- Время окончания - запланированное время окончания
- Исполнители - назначенные исполнители с уровнем квалификации
- Зависимость от - предыдущая задача/операция

---

## 9. Решённые задачи (История Issues)

### Issue #1: Создание планировщика задач
- Реализован базовый алгоритм планирования
- Расчёт длительности на основе шаблонов
- Планирование с учётом рабочего времени и обеда
- Сохранение данных через API

### Issue #3: Назначение исполнителей
- Парсинг параметров задач и операций
- Валидация исполнителей по параметрам
- Проверка доступности исполнителей
- Назначение множественных исполнителей
- Сохранение назначений через API

### Issue #5: Чтение количества исполнителей из шаблона
- Исправлено чтение поля "Исполнителей" из шаблонного проекта
- Вместо чтения из текущей строки, теперь читается из соответствующего шаблона

### Issue #7: Добавление логирования
- Добавлено подробное консольное логирование для каждого шага
- Улучшена отладка и диагностика проблем

### Issue #9: Fallback параметров операции на параметры задачи
- Если параметры операции не заполнены, используются параметры задачи
- Реализован механизм fallback для параметров

### Issue #11: Чтение параметров из шаблонной операции
- Параметры берутся из одноименной операции в шаблоне
- Дубликат Issue #9, улучшена логика чтения параметров

### Issue #13: Чтение параметров из шаблонной задачи или операции
- Унифицирован подход к чтению параметров из шаблона
- Параметры берутся из соответствующей задачи или операции в шаблоне

### Issue #15: Объединение параметров задачи и операции
- При совпадении кодов параметров, параметры операции имеют приоритет
- Реализовано корректное объединение параметров с учётом приоритета

### Issue #17: Финальная документация
- Подготовлен данный документ с полным описанием требований
- Описано происхождение кода `t2399`

---

## 10. Ключевые особенности реализации

### 10.1 Работа с ключами данных
Все ключи с пробелами и кириллицей обрабатываются через квадратные скобки:
```javascript
item['Задача проекта']
item['Норматив операции']
item['Предыдущая Операция']
```

### 10.2 Обработка рабочего времени
Функция `addWorkingTime()` корректно обрабатывает:
- Переходы через обеденный перерыв
- Переходы на следующий день
- Начало работы до/после рабочего времени
- Задачи длительностью ≤ 4 часов не разбиваются

### 10.3 Обработка зависимостей
Система отслеживает время завершения каждой задачи/операции в Map-структуре для быстрого доступа при проверке зависимостей.

### 10.4 Приоритет параметров (Issue #15)
При объединении параметров задачи и операции:
```javascript
// Сначала берём параметры задачи
const taskParams = parseParameterString(taskParamsStr);
// Затем параметры операции (перезапишут при совпадении кодов)
const operationParams = parseParameterString(operationParamsStr);
// Объединяем с приоритетом операции
const mergedParams = { ...taskParams, ...operationParams };
```

---

## 11. Требования к системе

### 11.1 Технические требования
- Современный браузер с поддержкой ES6+
- Доступ к API системы integram.io
- Глобальные переменные `db` и `xsrf` на странице

### 11.2 Требования к данным
- Проекты должны иметь статус "В работе"
- Шаблонные проекты должны содержать нормативы
- Исполнители должны иметь заполненные параметры (квалификация, роль)
- Задачи и операции должны иметь корректные названия для сопоставления с шаблоном

---

## 12. Решение проблем

### 12.1 Скрипт не запускается
- Проверьте наличие глобальных переменных `db` и `xsrf`
- Проверьте доступность div с классом `content`
- Откройте консоль браузера для просмотра ошибок и логов

### 12.2 Неверные длительности
- Проверьте данные шаблонного проекта
- Убедитесь, что нормативы указаны в минутах
- Проверьте значения в поле `Кол-во`
- Проверьте консоль для сообщений о расчёте длительности

### 12.3 Неверное время начала
- Проверьте настройки рабочего времени в отчёте 3283
- Убедитесь, что дата старта проекта указана корректно (формат dd.mm.yyyy)
- Проверьте зависимости между задачами (поля "Предыдущая Задача" и "Предыдущая Операция")
- Проверьте консоль для сообщений о планировании времени

### 12.4 Исполнители не назначаются
- Проверьте параметры задач/операций в проекте и шаблоне
- Убедитесь, что у исполнителей заполнены необходимые параметры
- Проверьте занятое время исполнителей
- Проверьте консоль для сообщений о валидации и назначении

---

## 13. Связанные ресурсы

- **Репозиторий:** https://github.com/ideav/orbits
- **Issue #1:** https://github.com/ideav/orbits/issues/1 - исходное задание на планировщик
- **Issue #3:** https://github.com/ideav/orbits/issues/3 - задание на назначение исполнителей
- **Pull Request #2:** https://github.com/ideav/orbits/pull/2 - реализация планировщика
- **Pull Request #4:** https://github.com/ideav/orbits/pull/4 - реализация назначения исполнителей (происхождение t2399)
- **Issues #5, #7, #9, #11, #13, #15:** улучшения и исправления
- **Pull Request #18:** https://github.com/ideav/orbits/pull/18 - данный документ

---

## 14. Лицензия и авторство

Этот проект разработан для системы integram.io/orbits с использованием Claude Code AI.

**Авторство:**
- Система спроектирована и реализована с помощью AI-ассистента Claude
- Все коды полей (включая `t2399`) определены в соответствии со структурой базы данных integram.io

---

*Документ подготовлен в рамках Issue #17*
*Дата создания: 2025-12-04*
