<style>
    .project-list-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .search-box {
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        flex: 1;
        font-size: 14px;
    }

    .filter-select {
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
        min-width: 150px;
        background-color: white;
    }

    .controls-row {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        align-items: center;
    }

    .project-list {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 30px;
    }

    .project-item {
        padding: 15px;
        border-bottom: 1px solid #dee2e6;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .project-item:hover {
        background-color: #f8f9fa;
    }

    .project-item.active {
        background-color: #e7f3ff;
        border-left: 3px solid #007bff;
    }

    .project-item:last-child {
        border-bottom: none;
    }

    .project-header {
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 5px;
    }

    .project-meta {
        font-size: 13px;
        color: #6c757d;
    }

    .btn-add-project {
        white-space: nowrap;
    }

    .task-section {
        margin-top: 30px;
        display: none;
    }

    .task-section.active {
        display: block;
    }

    .task-list, .operation-list {
        margin-top: 15px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
    }

    .task-item, .operation-item {
        padding: 12px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #fff;
    }

    .task-item:hover, .operation-item:hover {
        background-color: #f8f9fa;
    }

    .task-item.dragging, .operation-item.dragging {
        opacity: 0.5;
    }

    .task-order, .operation-order {
        font-weight: bold;
        margin-right: 10px;
        min-width: 30px;
        text-align: center;
    }

    .task-content, .operation-content {
        flex-grow: 1;
    }

    .task-actions, .operation-actions {
        display: flex;
        gap: 5px;
    }

    /* Financial columns for tasks */
    .task-financial {
        display: flex;
        gap: 15px;
        margin-right: 15px;
        min-width: 300px;
    }

    .task-quantity, .task-price, .task-sum {
        text-align: right;
        font-weight: 500;
        min-width: 90px;
    }

    /* Table header row */
    .task-header-row {
        padding: 12px;
        border-bottom: 2px solid #007bff;
        background-color: #f8f9fa;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold;
        font-size: 14px;
    }

    .task-header-order {
        font-weight: bold;
        margin-right: 10px;
        min-width: 30px;
        text-align: center;
        margin-left: 40px;
    }

    .task-header-content {
        flex-grow: 1;
    }

    .task-header-financial {
        display: flex;
        gap: 15px;
        margin-right: 15px;
        min-width: 300px;
    }

    .task-header-quantity, .task-header-price, .task-header-sum {
        text-align: right;
        font-weight: bold;
        min-width: 90px;
        font-size: 14px;
        color: #495057;
    }

    .task-header-actions {
        min-width: 200px;
    }

    /* Total row styles */
    .task-total-row {
        padding: 15px 12px;
        border-top: 2px solid #007bff;
        background-color: #f8f9fa;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold;
    }

    .task-total-label {
        font-size: 16px;
        margin-right: 10px;
        min-width: 80px;
    }

    .task-total-content {
        flex-grow: 1;
    }

    .task-total-count {
        font-size: 14px;
        color: #6c757d;
    }

    .task-total-financial {
        display: flex;
        gap: 15px;
        margin-right: 15px;
        min-width: 300px;
    }

    .task-total-quantity, .task-total-price, .task-total-sum {
        text-align: right;
        font-weight: bold;
        min-width: 90px;
        font-size: 15px;
    }

    .task-total-actions {
        min-width: 200px;
    }

    .operation-item {
        margin-left: 30px;
    }

    .modal-backdrop {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1040;
    }

    .modal-backdrop.show {
        display: block;
        opacity: 1 !important;
    }

    .modal-dialog-custom {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        background-color: #ffffff;
        opacity: 1;
        border-radius: 8px;
        padding: 20px;
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        z-index: 1050;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
    }

    .form-control-custom {
        width: 100%;
        padding: 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
    }

    textarea.form-control-custom {
        min-height: 80px;
        resize: vertical;
    }

    .btn-group-custom {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
    }

    .section-title {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #007bff;
    }

    .hidden {
        display: none !important;
    }

    .project-item.hidden-project {
        display: none !important;
    }

    .drag-handle {
        cursor: move;
        margin-right: 10px;
        color: #6c757d;
        font-size: 20px;
    }

    .delete-checkbox {
        margin-right: 10px;
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .delete-mode .task-item,
    .delete-mode .operation-item {
        background-color: #fff3cd;
    }

    .delete-mode .task-item.selected,
    .delete-mode .operation-item.selected {
        background-color: #f8d7da;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .product-item {
        padding: 12px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #fff;
        cursor: move;
    }

    .product-item:last-child {
        border-bottom: none;
    }

    .product-item:hover {
        background-color: #f8f9fa;
    }

    .product-item.dragging {
        opacity: 0.5;
    }

    .product-content {
        flex-grow: 1;
        display: flex;
        align-items: center;
    }

    .product-actions {
        display: flex;
        gap: 5px;
    }

    .product-delete-btn {
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        font-size: 18px;
        padding: 0 8px;
    }

    .product-delete-btn:hover {
        color: #c82333;
    }

    .chevron {
        cursor: pointer;
        margin-right: 10px;
        color: #6c757d;
        font-size: 20px;
        user-select: none;
        transition: transform 0.2s;
    }

    .chevron.expanded {
        transform: rotate(90deg);
    }

    .operation-count-bubble {
        display: inline-block;
        background-color: #007bff;
        color: white;
        border-radius: 12px;
        padding: 6px 8px;
        font-size: 12px;
        margin-right: 5px;
        min-width: 20px;
        text-align: center;
    }

    .operations-hidden {
        display: none;
    }

    /* Searchable Select Styles (select2-style) */
    .searchable-select-container {
        position: relative;
        flex: 2;
    }

    .searchable-select-trigger {
        width: 100%;
        padding: 8px 30px 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        background-color: white;
        cursor: pointer;
        font-size: 14px;
        text-align: left;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .searchable-select-trigger:hover {
        border-color: #80bdff;
    }

    .searchable-select-trigger.open {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .searchable-select-trigger .placeholder {
        color: #6c757d;
    }

    .searchable-select-trigger .arrow {
        position: absolute;
        right: 12px;
        pointer-events: none;
        color: #6c757d;
    }

    .searchable-select-dropdown {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ced4da;
        border-radius: 4px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        max-height: 400px;
        display: none;
    }

    .searchable-select-dropdown.show {
        display: block;
    }

    .searchable-select-search {
        padding: 8px;
        border-bottom: 1px solid #dee2e6;
    }

    .searchable-select-search input {
        width: 100%;
        padding: 6px 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
        outline: none;
    }

    .searchable-select-search input:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .searchable-select-options {
        max-height: 300px;
        overflow-y: auto;
    }

    .searchable-select-option {
        padding: 10px 12px;
        cursor: pointer;
        font-size: 14px;
        border-bottom: 1px solid #f8f9fa;
    }

    .searchable-select-option:last-child {
        border-bottom: none;
    }

    .searchable-select-option:hover {
        background-color: #f8f9fa;
    }

    .searchable-select-option.selected {
        background-color: #e7f3ff;
        color: #007bff;
        font-weight: 500;
    }

    .searchable-select-option.hidden {
        display: none;
    }

    .searchable-select-option .highlight {
        background-color: #fff3cd;
        font-weight: 600;
    }

    .searchable-select-no-results {
        padding: 20px;
        text-align: center;
        color: #6c757d;
        font-size: 14px;
    }
</style>

<div class="project-list-container">
    <div class="section-title">Конструктор проектов</div>

    <div class="controls-row">
        <button class="btn btn-primary btn-add-project" onclick="showAddProjectModal()">
            + Добавить проект
        </button>

        <input type="text" class="search-box" id="projectSearch" placeholder="Поиск по любому полю..." onkeyup="filterProjects()">
    </div>

    <div class="project-list" id="projectList">
        <!-- Projects will be loaded here -->
    </div>

    <div class="task-section" id="taskSection">
        <div class="section-title">
            <span id="selectedProjectName"></span>
            <button class="btn btn-sm btn-outline-secondary float-right" onclick="closeProjectView()" title="Закрыть" style="margin-left: 5px;">✖</button>
            <button class="btn btn-sm btn-outline-secondary float-right" onclick="editProject()">Редактировать проект</button>
            <button class="btn btn-sm btn-primary float-right" style="margin-right: 5px;" onclick="cloneProject()">Клонировать</button>
            <button class="btn btn-sm btn-warning float-right" style="margin-right: 5px;" id="toggleDeleteModeBtn" onclick="toggleDeleteMode()">Групповое удаление</button>
            <button class="btn btn-sm btn-danger float-right hidden" style="margin-right: 5px;" id="deleteSelectedBtn" onclick="deleteSelected()">Удалить выбранные</button>
        </div>

        <div class="controls-row">
            <button class="btn btn-primary btn-sm" onclick="showAddTaskModal()">
                + Добавить задачу
            </button>

            <select class="filter-select" id="directionFilter" onchange="filterTasksAndOperations()">
                <option value="">Все направления</option>
            </select>

            <select class="filter-select" id="workTypeFilter" onchange="filterTasksAndOperations()">
                <option value="">Все виды работ</option>
            </select>

            <select class="filter-select" id="projectStageFilter" onchange="filterTasksAndOperations()">
                <option value="">Все этапы</option>
            </select>

            <input type="text" class="search-box" id="taskSearch" placeholder="Поиск по любому полю..." onkeyup="filterTasksAndOperations()">
        </div>

        <div class="task-list" id="taskList">
            <!-- Tasks and operations will be loaded here -->
        </div>
    </div>
</div>

<!-- Project Modal -->
<div class="modal-backdrop" id="projectModalBackdrop" onclick="closeProjectModal()">
    <div class="modal-dialog-custom" onclick="event.stopPropagation()">
        <h5 id="projectModalTitle">Добавить проект</h5>

        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs" id="projectTabs" role="tablist" style="margin-bottom: 20px;">
            <li class="nav-item">
                <a class="nav-link active" id="projectInfo-tab" data-toggle="tab" href="#projectInfo" role="tab">Проект</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="projectProducts-tab" data-toggle="tab" href="#projectProducts" role="tab">Изделия</a>
            </li>
        </ul>

        <form id="projectForm">
            <input type="hidden" id="projectId">

            <!-- Tab Content -->
            <div class="tab-content" id="projectTabContent">
                <!-- Tab 1: Project Info -->
                <div class="tab-pane fade show active" id="projectInfo" role="tabpanel">
                    <div class="form-group">
                        <label for="projectName">Проект *</label>
                        <input type="text" class="form-control-custom" id="projectName" required>
                    </div>

                    <div class="form-group">
                        <label for="projectDescription">Описание</label>
                        <textarea class="form-control-custom" id="projectDescription"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="projectClient">Заказчик</label>
                        <select class="form-control-custom" id="projectClient">
                            <option value="">Выберите заказчика</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="projectStatus">Статус проекта</label>
                        <select class="form-control-custom" id="projectStatus">
                            <option value="">Выберите статус</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="projectObject">Объект</label>
                        <select class="form-control-custom" id="projectObject">
                            <option value="">Выберите объект</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="projectStart">Старт</label>
                        <input type="date" class="form-control-custom" id="projectStart">
                    </div>

                    <div class="form-group">
                        <label for="projectDeadline">Срок</label>
                        <input type="date" class="form-control-custom" id="projectDeadline">
                    </div>

                    <div class="form-group">
                        <label for="projectBudget">Бюджет</label>
                        <input type="number" class="form-control-custom" id="projectBudget" step="0.01">
                    </div>
                </div>

                <!-- Tab 2: Products -->
                <div class="tab-pane fade" id="projectProducts" role="tabpanel">
                    <div class="form-group">
                        <label>Добавить изделие</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <div class="searchable-select-container" id="productSelectContainer">
                                <div class="searchable-select-trigger" id="productSelectTrigger">
                                    <span class="placeholder">Выберите изделие...</span>
                                    <span class="arrow">▼</span>
                                </div>
                                <div class="searchable-select-dropdown" id="productSelectDropdown">
                                    <div class="searchable-select-search">
                                        <input type="text" placeholder="Поиск изделия..." id="productSearchInput">
                                    </div>
                                    <div class="searchable-select-options" id="productSelectOptions">
                                        <!-- Options will be populated here -->
                                    </div>
                                </div>
                                <input type="hidden" id="productSelectValue">
                            </div>
                            <button type="button" class="btn btn-primary" onclick="addProductToProject()">Добавить</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Изделия проекта</label>
                        <input type="text" class="form-control-custom" id="projectProductSearch" placeholder="Поиск по списку изделий..." style="margin-bottom: 10px;" onkeyup="filterProjectProducts()">
                        <div id="projectProductsList" style="border: 1px solid #dee2e6; border-radius: 4px; min-height: 200px; max-height: 400px; overflow-y: auto;">
                            <!-- Project products will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="btn-group-custom">
                <button type="button" class="btn btn-outline-secondary" onclick="closeProjectModal()">Отмена</button>
                <button type="submit" class="btn btn-primary">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<!-- Task Modal -->
<div class="modal-backdrop" id="taskModalBackdrop" onclick="closeTaskModal()">
    <div class="modal-dialog-custom" onclick="event.stopPropagation()">
        <h5 id="taskModalTitle">Добавить задачу</h5>
        <form id="taskForm">
            <input type="hidden" id="taskId">
            <input type="hidden" id="taskProjectId">

            <div class="form-group">
                <label for="taskName">Задача проекта *</label>
                <input type="text" class="form-control-custom" id="taskName" required>
            </div>

            <div class="form-group">
                <label for="taskDescription">Описание</label>
                <textarea class="form-control-custom" id="taskDescription"></textarea>
            </div>

            <div class="form-group">
                <label for="taskStatus">Статус задачи</label>
                <select class="form-control-custom" id="taskStatus">
                    <option value="">Выберите статус</option>
                </select>
            </div>

            <div class="form-group">
                <label for="taskQuantity">Количество</label>
                <input type="number" class="form-control-custom" id="taskQuantity" step="0.01">
            </div>

            <div class="form-group">
                <label for="taskUnit">Ед.изм.</label>
                <select class="form-control-custom" id="taskUnit">
                    <option value="">Выберите ед.изм.</option>
                </select>
            </div>

            <div class="btn-group-custom">
                <button type="button" class="btn btn-danger hidden" id="deleteTaskBtn" onclick="confirmDeleteTask()">Удалить</button>
                <div style="flex-grow: 1;"></div>
                <button type="button" class="btn btn-outline-secondary" onclick="closeTaskModal()">Отмена</button>
                <button type="submit" class="btn btn-primary">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<!-- Clone Project Modal -->
<div class="modal-backdrop" id="cloneModalBackdrop" onclick="closeCloneModal()">
    <div class="modal-dialog-custom" onclick="event.stopPropagation()">
        <h5>Клонировать проект</h5>
        <form id="cloneForm">
            <div class="form-group">
                <label for="cloneProjectName">Новое имя проекта *</label>
                <input type="text" class="form-control-custom" id="cloneProjectName" required>
            </div>

            <div class="btn-group-custom">
                <button type="button" class="btn btn-outline-secondary" onclick="closeCloneModal()">Отмена</button>
                <button type="submit" class="btn btn-primary">Клонировать</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-backdrop" id="deleteModalBackdrop" onclick="closeDeleteModal()">
    <div class="modal-dialog-custom" onclick="event.stopPropagation()">
        <h5>Подтверждение удаления</h5>
        <p id="deleteConfirmText">Вы уверены, что хотите удалить выбранные элементы?</p>

        <div class="btn-group-custom">
            <button type="button" class="btn btn-outline-secondary" onclick="closeDeleteModal()">Отмена</button>
            <button type="button" class="btn btn-danger" onclick="confirmDelete()">Удалить</button>
        </div>
    </div>
</div>

<!-- Operation Modal -->
<div class="modal-backdrop" id="operationModalBackdrop" onclick="closeOperationModal()">
    <div class="modal-dialog-custom" onclick="event.stopPropagation()">
        <h5 id="operationModalTitle">Добавить операцию</h5>
        <form id="operationForm">
            <input type="hidden" id="operationId">
            <input type="hidden" id="operationTaskId">

            <div class="form-group">
                <label for="operationDirection">Направление</label>
                <select class="form-control-custom" id="operationDirection">
                    <option value="">Выберите направление</option>
                </select>
            </div>

            <div class="form-group">
                <label for="operationWorkType">Вид работ</label>
                <select class="form-control-custom" id="operationWorkType">
                    <option value="">Выберите вид работ</option>
                </select>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="operationTemplateFilter" style="margin-right: 8px;">
                    Шаблонная
                </label>
            </div>

            <div class="form-group">
                <label for="operationTemplate">Операция (шаблон)</label>
                <select class="form-control-custom" id="operationTemplate">
                    <option value="">Выберите операцию</option>
                </select>
            </div>

            <div class="form-group" id="operationTemplateNameGroup" style="display: none;">
                <label>Операция (шаблон)</label>
                <div>
                    <a href="#" id="operationTemplateLink" target="edit_tmpl" style="color: #007bff; text-decoration: none;">-</a>
                </div>
            </div>

            <div class="form-group">
                <label for="operationName">Операция</label>
                <input type="text" class="form-control-custom" id="operationName" placeholder="Название операции">
            </div>

            <div class="form-group">
                <label for="operationQuantity">Кол-во</label>
                <input type="text" class="form-control-custom" id="operationQuantity">
            </div>

            <div class="form-group">
                <label for="operationUnit">Ед.изм.</label>
                <select class="form-control-custom" id="operationUnit">
                    <option value="">Выберите ед.изм.</option>
                </select>
            </div>

            <div class="form-group">
                <label for="operationStart">Начать</label>
                <input type="datetime-local" class="form-control-custom" id="operationStart">
            </div>

            <div class="btn-group-custom">
                <button type="button" class="btn btn-danger hidden" id="deleteOperationBtn" onclick="confirmDeleteOperation()">Удалить</button>
                <div style="flex-grow: 1;"></div>
                <button type="button" class="btn btn-outline-secondary" onclick="closeOperationModal()">Отмена</button>
                <button type="submit" class="btn btn-primary" id="saveOperationBtn">Сохранить</button>
            </div>
            <div id="operationLoadingIndicator" class="hidden" style="margin-top: 16px; text-align: center;">
                <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <span style="margin-left: 10px;">Добавление операций...</span>
            </div>
        </form>
    </div>
</div>

<script>
    // Load projects.js dynamically
    (function() {
        var script = document.createElement('script');
        script.src = 'https://' + window.location.host + '/download/' + db + '/js/projects.js?'+Math.random();
        script.onload = function() {
            if (typeof initProjectsWorkspace === 'function') {
                initProjectsWorkspace();
            }
        };
        document.head.appendChild(script);
    })();
</script>
