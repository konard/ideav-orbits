```markdown
# Описание данных

## Команда metadata

Команда для описания всех терминов и их свойств и связей — `metadata`. Будучи вызвана без параметров, она возвращает полное описание вашей базы:

```bash
curl --location 'https://integram.io/apix/metadata?JSON=1'
```

Если указать параметр `ID`, то в ответ вернется только описание термина с указанным ID, например, **Пользователь**:

```bash
curl --location 'https://integram.io/apix/metadata/18?JSON=1'
```

Здесь виден тип колонки Пользователь — `3` (SHORT) и его реквизиты со своими свойствами и атрибутами.

```json
[
    {
        "id": "18",
        "up": "0",
        "type": "3",
        "val": "Пользователь",
        "unique": "1",
        "reqs": [
            {
                "num": 1,
                "id": "115",
                "val": "Роль",
                "type": "3",
                "ref": "42",
                "ref_id": "114",
                "attrs": ":!NULL:164"
            },
            {
                "num": 2,
                "id": "41",
                "val": "Email",
                "type": "3",
                "attrs": ":!NULL:"
            },
            {
                "num": 3,
                "id": "30",
                "val": "Телефон",
                "type": "3"
            },
            {
                "num": 4,
                "id": "156",
                "val": "Дата",
                "type": "9",
                "attrs": "[TODAY]"
            },
            {
                "num": 5,
                "id": "33",
                "val": "Имя",
                "type": "3"
            },
            {
                "num": 6,
                "id": "39",
                "val": "Примечание",
                "type": "12"
            },
            {
                "num": 7,
                "id": "38",
                "val": "Фото",
                "type": "10"
            },
            {
                "num": 8,
                "id": "124",
                "val": "Activity",
                "type": "4"
            },
            {
                "num": 9,
                "id": "130",
                "val": "Secret",
                "type": "3"
            },
            {
                "num": 10,
                "id": "20",
                "val": "Password",
                "type": "6"
            },
            {
                "num": 11,
                "id": "125",
                "val": "Token",
                "type": "6"
            },
            {
                "num": 12,
                "id": "40",
                "val": "xsrf",
                "type": "6"
            },
            {
                "num": 13,
                "id": "647",
                "val": "Тег",
                "type": "3",
                "ref": "616",
                "ref_id": "617",
                "attrs": ":MULTI:"
            }
        ]
    }
]
```

### Расшифровка значений

*   `id` — ID термина или его колонки
*   `up` — родительский элемент, у метаданных всегда `0`
*   `type` — базовый тип термина
*   `val` — значение термина
*   `unique` — признак уникальности экземпляров термина
*   `num` — номер по порядку среди равных
*   `ref` — ID таблицы справочника для ссылочного поля
*   `ref_id` — ID ссылки на справочник для ссылочного поля

### Атрибуты (`attrs`)

Бывают следующие:
*   `:!NULL:` — признак обязательности заполнения
*   `:MULTI:` — признак множественного выбора у ссылочного поля
*   `:LABEL:` — псевдоним для ссылочного поля

Всё, что не включено в двоеточия, является значением по умолчанию для этого поля.

---

## Таблицы

### Список таблиц

Список таблиц, который видно в меню **Таблицы**, можно получить командой `dict`:

```bash
curl --location 'https://integram.io/apix/dict?JSON=1'
```

В ответе будет список таблиц вашей базы и их идентификаторы, по которым эти таблицы можно открыть.

```json
{
    "18": "Пользователь",
    "22": "Запрос",
    "29": "Формат",
    "42": "Роль",
    "47": "Доступ",
    "63": "Функция",
    "65": "Итог",
    "137": "Форма",
    "269": "Настройка",
    "300": "Категории",
    "301": "Вид",
    "515": "Опрос",
    "616": "Тег"
}
```

### Содержимое таблицы

Содержимое таблицы можно посмотреть, вызвав метод `object` с указанием ID таблицы, полученного из метода `dict`, например, **Роль** — `42`:

```bash
curl --location 'https://integram.io/apix/object/42?JSON_DATA=1'
```

> **Обратите внимание** на использование параметра `JSON_DATA` вместо `JSON`!

В ответе будет содержимое таблицы **Роль** в виде массива объектов (строк) в таком формате:
*   `i`: ID записи,
*   `u`: ID родителя,
*   `o`: порядок среди равных,
*   `r`: `["значение первой колонки", "значение второй колонки", ...]`

```json
[
  {
    "i": 145,
    "u": 1,
    "o": 1,
    "r": [
      "admin",
      "3",
      "6",
      ""
    ]
  },
  {
    "i": 164,
    "u": 1,
    "o": 1,
    "r": [
      "user",
      "2",
      "",
      ""
    ]
  },
  {
    "i": 512,
    "u": 1,
    "o": 1,
    "r": [
      "api",
      "2",
      "",
      ""
    ]
  },
  {
    "i": 626,
    "u": 1,
    "o": 1,
    "r": [
      "guest",
      "1",
      "",
      ""
    ]
  }
]
```

> **Примечание:** В текущей версии сервиса при использовании `JSON` вместо `JSON_DATA` структура ответа будет другая, более сложная. Рекомендуем использовать `JSON_DATA`.

---

## Записи

### Запросить список

Для любой таблицы из списка таблиц мы можем запросить набор записей, например, таблица клиентов, её ID `641`:

```bash
curl --location 'https://integram.io/apix/object/641?JSON=1'
```

В ответе каждая строчка будет представлена объектом, для которого указан ID, родитель (u), порядок среди равных (o) и набор значений колонок таблицы (r):

```json
[
  {
    "i": 649,
    "u": 1,
    "o": 1,
    "r": [
      "АО Ромашка",
      "Летняя, 21",
      "8(555)0123456"
    ]
  },
  {
    "i": 668,
    "u": 1,
    "o": 1,
    "r": [
      "ПАО Эллипс",
      "Центральная, 7",
      "8(555)6543210"
    ]
  }
]
```

---

## Справочные поля

Любая таблица, в том числе подчиненная, может быть использована как справочник. Значение в справочной колонке хранится как ID записи из соответствующего справочника.

> **На форме редактирования записи** справочные поля выглядят примерно так, как **Метка** и **Категория**. Поле **Метка** имеет множественный выбор, в то время как поле **Категория** позволяет выбрать только одно значение.

### Запросить справочник

Для запроса справочных значений используется команда `_ref_reqs` с опциональным указанием ID записи, для которой запрашивается справочник:

```bash
curl --location 'https://integram.io/apix/_ref_reqs/646?JSON=1&id=649'
```

В ответ будут получены значения из справочника, например:

```json
{
    "650": "Лид",
    "660": "Клиент",
    "661": "ЧС"
}
```

> **Рекомендация:** Необязательный параметр `id` записи лучше передавать всегда, потому что он может использоваться при вычислении значения по умолчанию для данного поля.

### Выбрать значение

При выборе значения из списка его можно сохранить, используя команду `_m_set` с ID редактируемой записи и параметром `t{ID колонки}`, равным ID выбранного значения.

**Пример:** ID колонки **Категория** — `646`, согласно метаданным, и для выбора **Категории Клиент** (ID `660`) у клиента с ID `649` следует отправить такую команду:

```bash
curl --location 'https://integram.io/apix/_m_set/649?JSON=1' \
--form 't646="660"'
```

В ответ будет получен ID созданного или измененного значения ссылки:

```json
{
    "id": "658",
    "obj": 649,
    "next_act": "nul",
    "args": "",
    "warnings": ""
}
```

Таким образом можно задать значение как для справочника с единственным выбором, так и для множественного. Если такой элемент множественного выбора уже присутствует, то мы получим в ответ его ID и никаких изменений сделано не будет.

### Удалить значение

Определить тип выпадающего списка можно по атрибуту `:MULTI:`, полученному в метаданных таблицы. Если атрибут есть, то это список с множественным выбором.

1.  **Единственное значение из выпадающего списка**  
    Удалить значение выпадающего списка с единственным выбором можно, отправив `" "` (пробел) в качестве значения колонки:

    ```bash
    curl --location 'https://integram.io/apix/_m_set/649?JSON=1' \
    --form 't646=" "'
    ```

2.  **Значения из списка с множественным выбором**  
    Для удаления значения списка с множественным выбором следует вызвать метод `_m_del` с ID удаляемой ссылки:

    ```bash
    curl --location 'https://integram.io/apix/_m_del/654?JSON=1'
    ```

### Дополнить справочник

При наличии доступа к справочнику вы можете добавлять туда значения командой `_m_new`. Параметры команды мы можем узнать из метаданных таблицы (например, **Клиент**).

```bash
curl --location 'integram.io/apix/metadata/641'
```

Метаданные выглядят вот так, и здесь мы видим ключ `"ref"`, который указывает на ID таблицы, которая используется как справочник.

```json
{
    "id": "641",
    "up": "0",
    "type": "3",
    "val": "Клиент",
    "unique": "0",
    "reqs": [
        {
            "num": 1,
            "id": "648",
            "val": "Тег",
            "type": "3",
            "ref": "616",
            "ref_id": "617",
            "attrs": ":MULTI::ALIAS=Метка:"
        },
        {
            "num": 2,
            "id": "646",
            "val": "Категория",
            "type": "3",
            "ref": "644",
            "ref_id": "645"
        }
    ]
}
```

То есть, для добавления записи в справочник **Категория** мы используем ID `644`, а также передаем параметры:
*   `t644` — значение записи
*   `up=1` — родитель записи, для справочников это, как правило, `1`

```bash
curl --location 'https://integram.io/apix/_m_new/644?JSON=1' \
--form 't644="Бывший"' \
--form 'up="1"'
```

Будет такой ответ, в котором мы видим ID созданной записи — `662`, который мы немедленно можем использовать в справочнике:

```json
{
    "id": 662,
    "obj": 662,
    "ord": 1,
    "next_act": "object",
    "args": "",
    "val": "Бывший"
}
```

В самом справочнике, при запросе его командой `_ref_reqs`, мы тоже видим это значение:

```json
{
    "650": "Лид",
    "660": "Клиент",
    "661": "ЧС",
    "662": "Бывший"
}
```
