```markdown
# API для Интеграм

> Описание API для системы Интеграм. Версия 1.0

## Авторизация

### Получение токенов

Авторизация пользователя доступна по API, если вы регистрировались по почте или задали себе пароль после регистрации через соц. сети (Google и другие):

```bash
curl --location 'https://integram.io/apix/auth?JSON=1' \
--form 'login="apiuser"' \
--form 'pwd="************"'
```

В ответ придет JSON с токенами XSRF и авторизационным:

```json
{
    "_xsrf": "cd4b6417a3940ed4a84h074d",
    "token": "ea15dcc3a8cae93e8f5e17e25b6710",
    "id": "632",
    "msg": ""
}
```

### Использование токенов

1. **Токен авторизации** следует передавать с каждым запросом в заголовке `Authorization`:

```bash
curl --location 'integram.io/apix/metadata/42' \
--header 'Authorization: ea15dcc3a8cae93e8f5e17e25b6710'
```

2. **Токен `_xsrf`** следует передавать с каждым POST-запросом на изменение данных или структуры:

```bash
curl --location 'https://integram.io/apix/_d_new?JSON=1' \
--form 't="3"' \
--form 'val="Клиент"' \
--header 'Authorization: ea15dcc3a8cae93e8f5e17e25b6710' \
--form '_xsrf="1cb413634d074d3804ed48"'
```

> **Примечание:** В дальнейших примерах, для компактности, мы будем опускать эти параметры: токен авторизации и xsrf.

### Basic HTTP Authentication

Также возможен вариант более простой авторизации, так называемая Basic HTTP Authentication, когда имя и пароль передаются в заголовке каждого запроса:

```
Authorization: Basic Username:Password
```

По RFC7617 фрагмент `Username:Password` должен быть закодирован в BASE64, однако, для простоты допускается отправить его без кодирования, это тоже сработает.

Пример использования:

```bash
curl -u "username:password" \
--location 'https://integram.io/apix/dict?JSON=1'
```

### Информация о пользователе

Когда у вас есть токен, можно узнать остальную информацию о пользователе и сессии, вызвав команду `xsrf`:

```bash
curl --location 'https://integram.io/apix/xsrf'
```

Ответ будет примерно таким, и вы можете использовать эту информацию:

```json
{
    "_xsrf": "cd4b6417a3940ed4a84h074d",
    "token": "ea15dcc3a8cae93e8f5e17e25b6710",
    "user": "apiuser",
    "role": "api",
    "id": "632",
    "msg": ""
}
```

---

```markdown
# Описание данных

## Команда metadata

Команда для описания всех терминов и их свойств и связей — `metadata`. Будучи вызвана без параметров, она возвращает полное описание вашей базы:

```bash
curl --location 'https://integram.io/apix/metadata?JSON=1'
```

Если указать параметр `ID`, то в ответ вернется только описание термина с указанным ID, например, **Пользователь**:

```bash
curl --location 'https://integram.io/apix/metadata/18?JSON=1'
```

Здесь виден тип колонки Пользователь — `3` (SHORT) и его реквизиты со своими свойствами и атрибутами.

```json
[
    {
        "id": "18",
        "up": "0",
        "type": "3",
        "val": "Пользователь",
        "unique": "1",
        "reqs": [
            {
                "num": 1,
                "id": "115",
                "val": "Роль",
                "type": "3",
                "ref": "42",
                "ref_id": "114",
                "attrs": ":!NULL:164"
            },
            {
                "num": 2,
                "id": "41",
                "val": "Email",
                "type": "3",
                "attrs": ":!NULL:"
            },
            {
                "num": 3,
                "id": "30",
                "val": "Телефон",
                "type": "3"
            },
            {
                "num": 4,
                "id": "156",
                "val": "Дата",
                "type": "9",
                "attrs": "[TODAY]"
            },
            {
                "num": 5,
                "id": "33",
                "val": "Имя",
                "type": "3"
            },
            {
                "num": 6,
                "id": "39",
                "val": "Примечание",
                "type": "12"
            },
            {
                "num": 7,
                "id": "38",
                "val": "Фото",
                "type": "10"
            },
            {
                "num": 8,
                "id": "124",
                "val": "Activity",
                "type": "4"
            },
            {
                "num": 9,
                "id": "130",
                "val": "Secret",
                "type": "3"
            },
            {
                "num": 10,
                "id": "20",
                "val": "Password",
                "type": "6"
            },
            {
                "num": 11,
                "id": "125",
                "val": "Token",
                "type": "6"
            },
            {
                "num": 12,
                "id": "40",
                "val": "xsrf",
                "type": "6"
            },
            {
                "num": 13,
                "id": "647",
                "val": "Тег",
                "type": "3",
                "ref": "616",
                "ref_id": "617",
                "attrs": ":MULTI:"
            }
        ]
    }
]
```

### Расшифровка значений

*   `id` — ID термина или его колонки
*   `up` — родительский элемент, у метаданных всегда `0`
*   `type` — базовый тип термина
*   `val` — значение термина
*   `unique` — признак уникальности экземпляров термина
*   `num` — номер по порядку среди равных
*   `ref` — ID таблицы справочника для ссылочного поля
*   `ref_id` — ID ссылки на справочник для ссылочного поля

### Атрибуты (`attrs`)

Бывают следующие:
*   `:!NULL:` — признак обязательности заполнения
*   `:MULTI:` — признак множественного выбора у ссылочного поля
*   `:LABEL:` — псевдоним для ссылочного поля

Всё, что не включено в двоеточия, является значением по умолчанию для этого поля.

---

## Таблицы

### Список таблиц

Список таблиц, который видно в меню **Таблицы**, можно получить командой `dict`:

```bash
curl --location 'https://integram.io/apix/dict?JSON=1'
```

В ответе будет список таблиц вашей базы и их идентификаторы, по которым эти таблицы можно открыть.

```json
{
    "18": "Пользователь",
    "22": "Запрос",
    "29": "Формат",
    "42": "Роль",
    "47": "Доступ",
    "63": "Функция",
    "65": "Итог",
    "137": "Форма",
    "269": "Настройка",
    "300": "Категории",
    "301": "Вид",
    "515": "Опрос",
    "616": "Тег"
}
```

### Содержимое таблицы

Содержимое таблицы можно посмотреть, вызвав метод `object` с указанием ID таблицы, полученного из метода `dict`, например, **Роль** — `42`:

```bash
curl --location 'https://integram.io/apix/object/42?JSON_DATA=1'
```

> **Обратите внимание** на использование параметра `JSON_DATA` вместо `JSON`!

В ответе будет содержимое таблицы **Роль** в виде массива объектов (строк) в таком формате:
*   `i`: ID записи,
*   `u`: ID родителя,
*   `o`: порядок среди равных,
*   `r`: `["значение первой колонки", "значение второй колонки", ...]`

```json
[
  {
    "i": 145,
    "u": 1,
    "o": 1,
    "r": [
      "admin",
      "3",
      "6",
      ""
    ]
  },
  {
    "i": 164,
    "u": 1,
    "o": 1,
    "r": [
      "user",
      "2",
      "",
      ""
    ]
  },
  {
    "i": 512,
    "u": 1,
    "o": 1,
    "r": [
      "api",
      "2",
      "",
      ""
    ]
  },
  {
    "i": 626,
    "u": 1,
    "o": 1,
    "r": [
      "guest",
      "1",
      "",
      ""
    ]
  }
]
```

> **Примечание:** В текущей версии сервиса при использовании `JSON` вместо `JSON_DATA` структура ответа будет другая, более сложная. Рекомендуем использовать `JSON_DATA`.

---

## Записи

### Запросить список

Для любой таблицы из списка таблиц мы можем запросить набор записей, например, таблица клиентов, её ID `641`:

```bash
curl --location 'https://integram.io/apix/object/641?JSON=1'
```

В ответе каждая строчка будет представлена объектом, для которого указан ID, родитель (u), порядок среди равных (o) и набор значений колонок таблицы (r):

```json
[
  {
    "i": 649,
    "u": 1,
    "o": 1,
    "r": [
      "АО Ромашка",
      "Летняя, 21",
      "8(555)0123456"
    ]
  },
  {
    "i": 668,
    "u": 1,
    "o": 1,
    "r": [
      "ПАО Эллипс",
      "Центральная, 7",
      "8(555)6543210"
    ]
  }
]
```

---

## Справочные поля

Любая таблица, в том числе подчиненная, может быть использована как справочник. Значение в справочной колонке хранится как ID записи из соответствующего справочника.

> **На форме редактирования записи** справочные поля выглядят примерно так, как **Метка** и **Категория**. Поле **Метка** имеет множественный выбор, в то время как поле **Категория** позволяет выбрать только одно значение.

### Запросить справочник

Для запроса справочных значений используется команда `_ref_reqs` с опциональным указанием ID записи, для которой запрашивается справочник:

```bash
curl --location 'https://integram.io/apix/_ref_reqs/646?JSON=1&id=649'
```

В ответ будут получены значения из справочника, например:

```json
{
    "650": "Лид",
    "660": "Клиент",
    "661": "ЧС"
}
```

> **Рекомендация:** Необязательный параметр `id` записи лучше передавать всегда, потому что он может использоваться при вычислении значения по умолчанию для данного поля.

### Выбрать значение

При выборе значения из списка его можно сохранить, используя команду `_m_set` с ID редактируемой записи и параметром `t{ID колонки}`, равным ID выбранного значения.

**Пример:** ID колонки **Категория** — `646`, согласно метаданным, и для выбора **Категории Клиент** (ID `660`) у клиента с ID `649` следует отправить такую команду:

```bash
curl --location 'https://integram.io/apix/_m_set/649?JSON=1' \
--form 't646="660"'
```

В ответ будет получен ID созданного или измененного значения ссылки:

```json
{
    "id": "658",
    "obj": 649,
    "next_act": "nul",
    "args": "",
    "warnings": ""
}
```

Таким образом можно задать значение как для справочника с единственным выбором, так и для множественного. Если такой элемент множественного выбора уже присутствует, то мы получим в ответ его ID и никаких изменений сделано не будет.

### Удалить значение

Определить тип выпадающего списка можно по атрибуту `:MULTI:`, полученному в метаданных таблицы. Если атрибут есть, то это список с множественным выбором.

1.  **Единственное значение из выпадающего списка**  
    Удалить значение выпадающего списка с единственным выбором можно, отправив `" "` (пробел) в качестве значения колонки:

    ```bash
    curl --location 'https://integram.io/apix/_m_set/649?JSON=1' \
    --form 't646=" "'
    ```

2.  **Значения из списка с множественным выбором**  
    Для удаления значения списка с множественным выбором следует вызвать метод `_m_del` с ID удаляемой ссылки:

    ```bash
    curl --location 'https://integram.io/apix/_m_del/654?JSON=1'
    ```

### Дополнить справочник

При наличии доступа к справочнику вы можете добавлять туда значения командой `_m_new`. Параметры команды мы можем узнать из метаданных таблицы (например, **Клиент**).

```bash
curl --location 'integram.io/apix/metadata/641'
```

Метаданные выглядят вот так, и здесь мы видим ключ `"ref"`, который указывает на ID таблицы, которая используется как справочник.

```json
{
    "id": "641",
    "up": "0",
    "type": "3",
    "val": "Клиент",
    "unique": "0",
    "reqs": [
        {
            "num": 1,
            "id": "648",
            "val": "Тег",
            "type": "3",
            "ref": "616",
            "ref_id": "617",
            "attrs": ":MULTI::ALIAS=Метка:"
        },
        {
            "num": 2,
            "id": "646",
            "val": "Категория",
            "type": "3",
            "ref": "644",
            "ref_id": "645"
        }
    ]
}
```

То есть, для добавления записи в справочник **Категория** мы используем ID `644`, а также передаем параметры:
*   `t644` — значение записи
*   `up=1` — родитель записи, для справочников это, как правило, `1`

```bash
curl --location 'https://integram.io/apix/_m_new/644?JSON=1' \
--form 't644="Бывший"' \
--form 'up="1"'
```

Будет такой ответ, в котором мы видим ID созданной записи — `662`, который мы немедленно можем использовать в справочнике:

```json
{
    "id": 662,
    "obj": 662,
    "ord": 1,
    "next_act": "object",
    "args": "",
    "val": "Бывший"
}
```

В самом справочнике, при запросе его командой `_ref_reqs`, мы тоже видим это значение:

```json
{
    "650": "Лид",
    "660": "Клиент",
    "661": "ЧС",
    "662": "Бывший"
}
```

---

## Работа с записями

### Создание новой записи

Для создания новой записи используется команда `_m_new` с указанием ID типа создаваемого объекта. Необходимо передать параметры:
*   `up` — ID родительского объекта (для независимых объектов используйте `up=1`)
*   `t{ID типа}` — значение для основного поля объекта
*   `t{ID реквизита}` — значения для каждого реквизита (необязательно)

**Пример создания клиента:**

```bash
curl --location 'https://integram.io/apix/_m_new/641?JSON=1' \
--form 'up="1"' \
--form 't641="ООО Вектор"' \
--form 't642="Южная, 15"' \
--form 't643="8(555)1112233"'
```

Ответ будет содержать ID созданной записи:

```json
{
    "id": 670,
    "obj": 670,
    "ord": 1,
    "next_act": "object",
    "args": "",
    "val": "ООО Вектор"
}
```

#### Создание записи со ссылочными полями

При создании записи можно сразу указать значения для ссылочных полей, передав ID записи из справочника:

```bash
curl --location 'https://integram.io/apix/_m_new/641?JSON=1' \
--form 'up="1"' \
--form 't641="ООО Вектор"' \
--form 't646="660"'
```

Где `646` — ID колонки **Категория**, а `660` — ID значения **Клиент** из справочника категорий.

#### Создание нового значения в справочнике на лету

Если вы хотите создать новое значение в справочнике прямо при создании основной записи, используйте параметр `NEW_{ID реквизита}`:

```bash
curl --location 'https://integram.io/apix/_m_new/641?JSON=1' \
--form 'up="1"' \
--form 't641="ООО Вектор"' \
--form 'NEW_646="Партнёр"'
```

Система автоматически создаст новое значение **Партнёр** в справочнике **Категория** и свяжет его с создаваемым клиентом.

#### Значения по умолчанию

Если для реквизита задано значение по умолчанию в атрибутах метаданных, оно будет автоматически применено при создании записи, если вы не передадите явное значение. Значения по умолчанию могут быть:
*   Константами (например, `[TODAY]` для даты)
*   Вычисляемыми выражениями
*   Результатами запросов к другим таблицам

#### Уникальность записей

Если тип объекта имеет признак уникальности (`unique=1` в метаданных), система проверит наличие записи с таким же значением. Если запись уже существует:
*   Вернётся ID существующей записи
*   Параметр `next_act` будет установлен в `edit_obj`
*   В ответе будет предупреждение о том, что запись уже существует

```json
{
    "id": 649,
    "obj": 641,
    "ord": 1,
    "next_act": "edit_obj",
    "args": "exists1=1",
    "val": "АО Ромашка",
    "warning": "Запись уже существует"
}
```

---

### Изменение полей записи

Для изменения значений отдельных полей существующей записи используется команда `_m_set` с указанием ID редактируемой записи:

```bash
curl --location 'https://integram.io/apix/_m_set/649?JSON=1' \
--form 't642="Летняя, 21А"' \
--form 't643="8(555)9998877"'
```

Где:
*   `649` — ID редактируемой записи
*   `t642` — ID реквизита **Адрес** с новым значением
*   `t643` — ID реквизита **Телефон** с новым значением

Ответ будет содержать ID последнего изменённого реквизита:

```json
{
    "id": "655",
    "obj": 649,
    "next_act": "nul",
    "args": "",
    "warnings": ""
}
```

#### Изменение ссылочного поля с единственным выбором

Для изменения значения в ссылочном поле с единственным выбором передайте ID нового значения из справочника:

```bash
curl --location 'https://integram.io/apix/_m_set/649?JSON=1' \
--form 't646="661"'
```

Чтобы **очистить** значение ссылочного поля с единственным выбором, передайте пробел:

```bash
curl --location 'https://integram.io/apix/_m_set/649?JSON=1' \
--form 't646=" "'
```

#### Добавление значений в поле с множественным выбором

Для ссылочных полей с атрибутом `:MULTI:` можно передавать массив значений или добавлять значения по одному:

```bash
curl --location 'https://integram.io/apix/_m_set/649?JSON=1' \
--form 't648="618"' \
--form 't648="619"'
```

Или передать массив в одном параметре:

```bash
curl --location 'https://integram.io/apix/_m_set/649?JSON=1' \
--form 't648[]=618' \
--form 't648[]=619'
```

Если значение уже присутствует в списке, система вернёт предупреждение, но не создаст дубликат.

#### Загрузка файлов

Для загрузки файла используйте `_m_set` с передачей файла в поле, соответствующем ID реквизита с типом FILE:

```bash
curl --location 'https://integram.io/apix/_m_set/649?JSON=1' \
--form 't651=@"/path/to/document.pdf"'
```

Где `651` — ID реквизита с типом FILE. Файл будет сохранён на сервере, а в базе данных сохранится имя файла.

#### Удаление значения поля

Чтобы удалить значение обычного поля (не ссылочного), передайте пустую строку:

```bash
curl --location 'https://integram.io/apix/_m_set/649?JSON=1' \
--form 't643=""'
```

Для удаления файла также передайте пустую строку — файл будет удалён с сервера.

---

### Удаление записи

Для удаления записи используется команда `_m_del` с указанием ID удаляемой записи:

```bash
curl --location 'https://integram.io/apix/_m_del/670?JSON=1'
```

Ответ подтвердит удаление:

```json
{
    "id": "641",
    "obj": 670,
    "next_act": "object",
    "args": ""
}
```

#### Ограничения при удалении

Система не позволит удалить запись, если:
1.  **На неё есть ссылки из других записей** — необходимо сначала удалить или изменить все ссылающиеся записи
2.  **Это метаданные** (записи со структурой таблиц)
3.  **Пользователь пытается удалить себя** (для таблицы **Пользователь**)

В этих случаях вернётся ошибка с соответствующим сообщением:

```json
{
    "error": "Нельзя удалить объект, на который существует ссылки (всего: 5)!"
}
```

#### Каскадное удаление

При удалении записи автоматически удаляются:
*   Все её реквизиты (значения полей)
*   Все вложенные записи (если запись является родительской для других)
*   Связанные файлы с сервера (для полей типа FILE)

#### Удаление значения из множественного выбора

Для удаления отдельного значения из поля с множественным выбором используйте `_m_del` с ID конкретной ссылки (не основной записи):

```bash
curl --location 'https://integram.io/apix/_m_del/654?JSON=1'
```

Где `654` — ID связи между записью и значением справочника. Этот ID можно получить при запросе записи через `object` с параметром `JSON_DATA`.

---

### Копирование записи

Для создания копии существующей записи со всеми её реквизитами используйте команду `_m_save` с параметром `copybtn`:

```bash
curl --location 'https://integram.io/apix/_m_save/649?JSON=1' \
--form 'copybtn="1"'
```

Ответ будет содержать ID новой (скопированной) записи:

```json
{
    "id": 671,
    "obj": 649,
    "next_act": "edit_obj",
    "args": "copied1=1",
    "val": "АО Ромашка"
}
```

#### Копирование с изменением значения

Вы можете изменить значение основного поля при копировании, передав параметр `t{ID типа}`:

```bash
curl --location 'https://integram.io/apix/_m_save/649?JSON=1' \
--form 'copybtn="1"' \
--form 't641="АО Ромашка (копия)"'
```

Будет создана копия записи с новым значением **АО Ромашка (копия)**, при этом все реквизиты (адрес, телефон, категория и т.д.) будут скопированы из оригинальной записи.

---

## Дополнительные возможности

### Формат ответа

Все команды API возвращают JSON-ответ со следующей структурой:

```json
{
    "id": "ID созданной/изменённой записи или реквизита",
    "obj": "ID объекта, с которым работали",
    "ord": "Порядковый номер записи среди равных",
    "next_act": "Рекомендуемое следующее действие (object, edit_obj, nul)",
    "args": "Дополнительные параметры для следующего действия",
    "val": "Значение записи",
    "warnings": "Предупреждения (если есть)"
}
```

### Параметры запроса

**Обязательный параметр** для всех команд API:
*   `JSON=1` — указывает, что ответ должен быть в формате JSON

**Дополнительные параметры:**
*   `JSON_DATA=1` — для команды `object` возвращает данные в упрощённом формате (вместо `JSON`)
*   `_xsrf` — токен XSRF для POST-запросов на изменение данных
*   `Authorization` — токен авторизации в заголовке запроса

### Обработка ошибок

При возникновении ошибки API возвращает JSON с описанием проблемы:

```json
{
    "error": "Описание ошибки",
    "msg": "Дополнительная информация"
}
```

Типичные ошибки:
*   `"Wrong id"` — неверный или отсутствующий ID
*   `"Invalid ID"` — недопустимое значение ID
*   `"You don't have permission"` — недостаточно прав доступа
*   `"The record already exists"` — попытка создать дубликат уникальной записи
*   `"Object not found"` — запись с указанным ID не найдена
*   `"Wrong Reference"` — неверный ID в ссылочном поле

### Права доступа

Все операции проверяют права доступа пользователя:
*   **READ** — чтение данных (`metadata`, `dict`, `object`, `_ref_reqs`)
*   **WRITE** — создание и изменение (`_m_new`, `_m_set`, `_m_save`)
*   **DELETE** — удаление (`_m_del`)

Права настраиваются через таблицу **Доступ** в системе Интеграм и зависят от роли пользователя.

---
